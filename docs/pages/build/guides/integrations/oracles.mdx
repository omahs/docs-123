# Integration of Oracles ( Chainlink , Pyth & Chronicel )

## Overview

This guide provides basic instructions for integrating Oracle services with Stackr Micro Rollups (MRU) using a bridge contract. This setup allows you to feed external price data into the rollup, enabling state transitions based on live data from Chainlink, Chronicle, or Pyth.

## What are Oracles

Oracles are external data sources that provide real-world information to blockchain networks. They act as a bridge between off-chain data and on-chain smart contracts, allowing contracts to execute based on external events or information.

There are several type of data feeds offered by oracles like Price Feeds, Proof of reserve Feeds, Entropy, etc. from the following oracle networks -

- [**Chainlink**](https://chain.link/)
- [**Pyth**](https://www.pyth.network/)
- [**Chronicle**](https://chroniclelabs.org/)

## Prerequisites

Before you begin this tutorial, please ensure you go through the following:

- Basic understanding of the Stackr Micro rollup framework : [Zero to One](/build/zero-to-one/getting-started)
- Familiarity with Solidity and smart contract deployment
- Knowledge & access to the preferred oracle service : [What are Blockchain Oracle](https://chain.link/education/blockchain-oracles)

## How to build ?

::::steps

### Initalizing the Rollup

Start by initialising MRU using the @stackr/cli and choosing the Bridge template, and adding a name for your project.

```bash [Terminal]
$ npx @stackr/cli@latest init

? Pick a template > Bridge
? Project Name > Oracle-bridge

$ cd Oracle-bridge
```

Implement a state transition function that updates the rollup's state based on the Oracle's price feed.

```ts [transitions.ts]
const updateOraclePrice: STF<BridgeState, UpdateOracelPriceInput> = {
  handler: ({ state, inputs, msgSender }) => {
    const { price, timestamp } = inputs;

    state.bridgeState.price = price;

    return state;
  },
};
```

### Creating the Bridge contract

A TokenBridge.sol is by default added in the project template for reference. Bridge contract can call createTicket on the AppInbox to initiate the message bridging.

Depending on the Oracle service, integrate the appropriate API or contract to retrieve live price data. Here are examples for each of the oracles -

:::info
You can replace the address according the pair and the network of you choice in the above examples
:::

#### Chainlink

```solidity
function getLatestPrice() internal view returns (uint256) {
    priceFeed = AggregatorV3Interface(
            0x694AA1769357215DE4FAC081bf1f309aDC325306
        ); // ETH/USD on Sepolia
    (, int256 price, , , ) = priceFeed.latestRoundData();
    return price;
}
```

#### Pyth

```solidity
function getLatestPrice() internal view returns (uint256) {
    bytes32 priceFeedId = 0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace; // ETH/USD on Sepolia
    PythStructs.Price memory price = pyth.getPriceNoOlderThan(
            priceFeedId,
            60
        );
    return price.price;
}
```

#### Chronicle

```solidity
function getLatestPrice() internal view returns (uint256) {
    chronicle = IChronicle(
            address(0xdd6D76262Fd7BdDe428dcfCd94386EbAe0151603)  // ETH/USD on Sepolia
        );
    uint price = chronicle.read();
    return price;
}
```

### Setting up the Bridge ticket handler in MRU

Next we need to modify the rollup to process tickets from the OracleBridge, updating the rollup state accordingly.

```ts [index.ts]
Bridge.init(rollup, {
  handlers: {
    ORACLE_ETH_USDC: async (args) => {
      const [_price] = abiCoder.decode(["int"], args.data);

      const inputs = {
        price: _price.toString(),
        timestamp: Date.now(),
      };

      const signature = await signMessage(
        operator,
        UpdateOraclePriceSchema,
        inputs
      );
      const action = UpdateOraclePriceSchema.actionFrom({
        inputs,
        signature,
        msgSender: operator.address,
      });

      return {
        transitionName: "updateOraclePrice",
        action: action,
      };
    },
  },
});
```

::::

## Next steps

That completes the setup of the Oracle - Bridge with the MRU. Once the contracts are deployed on chain and configured with the AppInbox , the MRU is all ready to be used along with prices feeds from the oracle. You can further create your own logic to use the price feed in your Micro rollup.

For a detailed step-by-step guide and an example MRU for this integration refer to the [Github Repo](https://github.com/Dhruv-2003/Oracles-mru-integration?tab=readme-ov-file)
