# XMTP Integration with Micro-rollups

## Overview

This guide will help you in building an Event Notifier for Stackr’s Micro-rollup events using XMTP. We will be integrating Stackr’s Micro-rollup with XMTP to leverage the capabilities and utility of micro-rollup and XMTP.

## What is XMTP and what are we building?

XMTP (Extensible Message Transport Protocol) is an open protocol, network, and standards for secure, private web3 messaging.
XMTP enables encrypted communication between digital wallets, allowing secure transactions and information exchange between parties.

The event notifier that we are going to build will implement XMTP as a communication layer for MRU events and updates. When significant events occur in the MRU, it will trigger XMTP messages. MRU node will use XMTP to broadcast event notifications to the wallet performing action on the rollup.

## Pre-requisites

Before you begin this guide, please ensure you already know or go through the following:

- Basic knowledge of Stackr’s Micro rollups: [Zero to One](/build/zero-to-one/getting-started)
- Basic knowledge of XMTP: [Intro to XMTP](https://docs.xmtp.org/)
- An initialised Next application [Create next application](https://nextjs.org/docs/getting-started/installation)

## How to build?

### 1. Initialise the MRU

Initialise the MRU using the `@stackr/cli` and choosing the ERC20 template and choosing a name for the project.

```bash [Terminal]
$ npx @stackr/cli@latest init

? Pick a template > ERC20
? Project Name > xmtp-notifier

$ cd xmtp-notifier
```

### 2. Adding XMTP Client to MRU

To enable the MRU to send messages to the user using XMTP, a client is required along with functions to create conversations and send messages.

```ts [index.ts]
class XMTPNotifier {
  xmtpClient: Client;
  // mapping to store XMTP conversations, keyed by msg sender address.
  conversations: Map<string, Conversation> = new Map();

  constructor(xmtpClient: Client) {
    this.xmtpClient = xmtpClient;
  }

  async getOrCreateConversation(address: string): Promise<Conversation> {
    if (!this.conversations.has(address)) {
      const conversation = await this.xmtpClient.conversations.newConversation(
        address
      );
      this.conversations.set(address, conversation);
    }
    return this.conversations.get(address)!;
  }

  async notifyUser(address: string, message: string) {
    try {
      const conversation = await this.getOrCreateConversation(address);
      await conversation.send(message);
      console.log(`Sent message to ${address}:`, message);
    } catch (error) {
      console.error(`Failed to send message to ${address}:`, error);
    }
  }
}

let xmtpNotifier: XMTPNotifier;

async function initializeXMTP() {
  const wallet = new Wallet(process.env.PRIVATE_KEY!);
  const xmtpClient = await Client.create(wallet);
  xmtpNotifier = new XMTPNotifier(xmtpClient);
  console.log("XMTP client initialized");
}
```

Here, we have defined a class named as `XMTPNotifier` where we initialise the XMTP client in the constructor and defined some functions required for messaging.

The `getOrCreateConversation` function —

1. Takes in the address of the user and checks if it has conversations initialised or not.
2. If the conversation is not initialised, it initialises a conversation.
3. Finally, it returns the conversation with the user.

The `notifyUser` function —

1. Takes in the address and the message for the user and calls the `getOrCreateConversation` to start a conversation
2. After that, it sends the message to the user.

The `initializeXMTP` function is used to initialise the XMTP client by creating a wallet from the Operator's private key.

### 3. Updating Event Listeners

We also need to update event listeners in order to notify the user when an event is occured.

```ts [index.ts]
events.subscribe(ActionEvents.SUBMIT, async (args) => {
  if (args.msgSender) {
    await xmtpNotifier.notifyUser(
      args.msgSender as string,
      `Action submitted: ${JSON.stringify(args)}`
    );
  }
});
```

Here, we are passing the string `Action submitted: ${JSON.stringify(args)}` as the message to the user.

We also need to update the MRU server run function.

```ts [index.ts]
async function initializeServer() {
  await initializeXMTP();

  app.listen(3000, () => {
    console.log("listening on port 3000");
  });
}

initializeServer().catch(console.error);
```

### 4. Adding XMTP to Frontend

We also need to initialise a client in the frontend for XMTP and start a message stream to listen to coming messages and display them.

```ts [pages/index.ts]
async function initializeXMTP() {
  if (walletClient && publicClient) {
    try {
      const signer: Signer = {
        getAddress: () => Promise.resolve(walletClient.account.address),
        signMessage: (message: string) => walletClient.signMessage({ message }),
      };

      const client = await Client.create(signer, { env: "dev" });
      setXmtpClient(client);
      startMessageStream(client);
    } catch (error) {
      console.error("Error initializing XMTP client:", error);
    }
  }
}

async function startMessageStream(client: Client) {
  const stream = await client.conversations.stream();
  for await (const conversation of stream) {
    for await (const message of await conversation.streamMessages()) {
      setMessages((prevMessages) => [...prevMessages, message.content]);
      console.log("Received message:", message);
    }
  }
}
```

## Next steps

That completes the guide for building an Event notifier for MRU with XMTP.
For detailed guide, complete examples and implementation details, refer to this repository: [Github Repo](https://github.com/Architsharma7/XMTP-MRU)